\hypertarget{_a_audio_extensions_8h_source}{}\doxysection{AAudio\+Extensions.\+h}
\label{_a_audio_extensions_8h_source}\index{build/juce\_audio\_devices/native/oboe/src/aaudio/AAudioExtensions.h@{build/juce\_audio\_devices/native/oboe/src/aaudio/AAudioExtensions.h}}
\mbox{\hyperlink{_a_audio_extensions_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/*}}
\DoxyCodeLine{2 \textcolor{comment}{ * Copyright 2019 The Android Open Source Project}}
\DoxyCodeLine{3 \textcolor{comment}{ *}}
\DoxyCodeLine{4 \textcolor{comment}{ * Licensed under the Apache License, Version 2.0 (the "{}License"{});}}
\DoxyCodeLine{5 \textcolor{comment}{ * you may not use this file except in compliance with the License.}}
\DoxyCodeLine{6 \textcolor{comment}{ * You may obtain a copy of the License at}}
\DoxyCodeLine{7 \textcolor{comment}{ *}}
\DoxyCodeLine{8 \textcolor{comment}{ *      http://www.apache.org/licenses/LICENSE-\/2.0}}
\DoxyCodeLine{9 \textcolor{comment}{ *}}
\DoxyCodeLine{10 \textcolor{comment}{ * Unless required by applicable law or agreed to in writing, software}}
\DoxyCodeLine{11 \textcolor{comment}{ * distributed under the License is distributed on an "{}AS IS"{} BASIS,}}
\DoxyCodeLine{12 \textcolor{comment}{ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.}}
\DoxyCodeLine{13 \textcolor{comment}{ * See the License for the specific language governing permissions and}}
\DoxyCodeLine{14 \textcolor{comment}{ * limitations under the License.}}
\DoxyCodeLine{15 \textcolor{comment}{ */}}
\DoxyCodeLine{16 }
\DoxyCodeLine{17 \textcolor{preprocessor}{\#ifndef OBOE\_AAUDIO\_EXTENSIONS\_H}}
\DoxyCodeLine{18 \textcolor{preprocessor}{\#define OBOE\_AAUDIO\_EXTENSIONS\_H}}
\DoxyCodeLine{19 }
\DoxyCodeLine{20 \textcolor{preprocessor}{\#include <dlfcn.h>}}
\DoxyCodeLine{21 \textcolor{preprocessor}{\#include <stdint.h>}}
\DoxyCodeLine{22 }
\DoxyCodeLine{23 \textcolor{preprocessor}{\#include <sys/system\_properties.h>}}
\DoxyCodeLine{24 }
\DoxyCodeLine{25 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_oboe_debug_8h}{common/OboeDebug.h}}"{}}}
\DoxyCodeLine{26 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_oboe_8h}{oboe/Oboe.h}}"{}}}
\DoxyCodeLine{27 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_a_audio_loader_8h}{AAudioLoader.h}}"{}}}
\DoxyCodeLine{28 }
\DoxyCodeLine{29 \textcolor{keyword}{namespace }\mbox{\hyperlink{namespaceoboe}{oboe}} \{}
\DoxyCodeLine{30 }
\DoxyCodeLine{31 \textcolor{preprocessor}{\#define LIB\_AAUDIO\_NAME          "{}libaaudio.so"{}}}
\DoxyCodeLine{32 \textcolor{preprocessor}{\#define FUNCTION\_IS\_MMAP         "{}AAudioStream\_isMMapUsed"{}}}
\DoxyCodeLine{33 \textcolor{preprocessor}{\#define FUNCTION\_SET\_MMAP\_POLICY "{}AAudio\_setMMapPolicy"{}}}
\DoxyCodeLine{34 \textcolor{preprocessor}{\#define FUNCTION\_GET\_MMAP\_POLICY "{}AAudio\_getMMapPolicy"{}}}
\DoxyCodeLine{35 }
\DoxyCodeLine{36 \textcolor{preprocessor}{\#define AAUDIO\_ERROR\_UNAVAILABLE  static\_cast<aaudio\_result\_t>(Result::ErrorUnavailable)}}
\DoxyCodeLine{37 }
\DoxyCodeLine{38 \textcolor{keyword}{typedef} \textcolor{keyword}{struct }AAudioStreamStruct         \mbox{\hyperlink{namespaceoboe_ac7cdd4062ef770523057fef4aaf96abf}{AAudioStream}};}
\DoxyCodeLine{39 }
\DoxyCodeLine{43 \textcolor{keyword}{class }\mbox{\hyperlink{classoboe_1_1_a_audio_extensions}{AAudioExtensions}} \{}
\DoxyCodeLine{44 \textcolor{keyword}{public}:}
\DoxyCodeLine{45     \mbox{\hyperlink{classoboe_1_1_a_audio_extensions_ab7286d412131e31f09fa61b5d8abac9b}{AAudioExtensions}}() \{}
\DoxyCodeLine{46         int32\_t policy = getIntegerProperty(\textcolor{stringliteral}{"{}aaudio.mmap\_policy"{}}, 0);}
\DoxyCodeLine{47         mMMapSupported = \mbox{\hyperlink{classoboe_1_1_a_audio_extensions_a651d0e11691bb9612b05ea33cee1c189}{isPolicyEnabled}}(policy);}
\DoxyCodeLine{48 }
\DoxyCodeLine{49         policy = getIntegerProperty(\textcolor{stringliteral}{"{}aaudio.mmap\_exclusive\_policy"{}}, 0);}
\DoxyCodeLine{50         mMMapExclusiveSupported = \mbox{\hyperlink{classoboe_1_1_a_audio_extensions_a651d0e11691bb9612b05ea33cee1c189}{isPolicyEnabled}}(policy);}
\DoxyCodeLine{51     \}}
\DoxyCodeLine{52 }
\DoxyCodeLine{53     \textcolor{keyword}{static} \textcolor{keywordtype}{bool} \mbox{\hyperlink{classoboe_1_1_a_audio_extensions_a651d0e11691bb9612b05ea33cee1c189}{isPolicyEnabled}}(int32\_t policy) \{}
\DoxyCodeLine{54         \textcolor{keywordflow}{return} (policy == AAUDIO\_POLICY\_AUTO || policy == AAUDIO\_POLICY\_ALWAYS);}
\DoxyCodeLine{55     \}}
\DoxyCodeLine{56 }
\DoxyCodeLine{57     \textcolor{keyword}{static} \mbox{\hyperlink{classoboe_1_1_a_audio_extensions}{AAudioExtensions}} \&\mbox{\hyperlink{classoboe_1_1_a_audio_extensions_a7648221d8473954b7a84363ee7dee689}{getInstance}}() \{}
\DoxyCodeLine{58         \textcolor{keyword}{static} \mbox{\hyperlink{classoboe_1_1_a_audio_extensions}{AAudioExtensions}} instance;}
\DoxyCodeLine{59         \textcolor{keywordflow}{return} instance;}
\DoxyCodeLine{60     \}}
\DoxyCodeLine{61 }
\DoxyCodeLine{62     \textcolor{keywordtype}{bool} \mbox{\hyperlink{classoboe_1_1_a_audio_extensions_aea8a59b0cd2747c229d8b991187ad4bf}{isMMapUsed}}(\mbox{\hyperlink{classoboe_1_1_audio_stream}{oboe::AudioStream}} *oboeStream) \{}
\DoxyCodeLine{63         \mbox{\hyperlink{namespaceoboe_ac7cdd4062ef770523057fef4aaf96abf}{AAudioStream}} *aaudioStream = (\mbox{\hyperlink{namespaceoboe_ac7cdd4062ef770523057fef4aaf96abf}{AAudioStream}} *) oboeStream-\/>\mbox{\hyperlink{classoboe_1_1_audio_stream_a8b9c04ff659ccbcfcf6bc08a1a01a69c}{getUnderlyingStream}}();}
\DoxyCodeLine{64         \textcolor{keywordflow}{return} \mbox{\hyperlink{classoboe_1_1_a_audio_extensions_aea8a59b0cd2747c229d8b991187ad4bf}{isMMapUsed}}(aaudioStream);}
\DoxyCodeLine{65     \}}
\DoxyCodeLine{66 }
\DoxyCodeLine{67     \textcolor{keywordtype}{bool} \mbox{\hyperlink{classoboe_1_1_a_audio_extensions_abd8625b814ed2fad50b4399214428a6f}{isMMapUsed}}(\mbox{\hyperlink{namespaceoboe_ac7cdd4062ef770523057fef4aaf96abf}{AAudioStream}} *aaudioStream) \{}
\DoxyCodeLine{68         \textcolor{keywordflow}{if} (loadSymbols()) \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{69         \textcolor{keywordflow}{if} (mAAudioStream\_isMMap == \textcolor{keyword}{nullptr}) \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{70         \textcolor{keywordflow}{return} mAAudioStream\_isMMap(aaudioStream);}
\DoxyCodeLine{71     \}}
\DoxyCodeLine{72 }
\DoxyCodeLine{81     int32\_t \mbox{\hyperlink{classoboe_1_1_a_audio_extensions_af46cb1fbf72ed842a361b8a5432381c3}{setMMapEnabled}}(\textcolor{keywordtype}{bool} \mbox{\hyperlink{namespacegl_a6dfcb2772a382ca14a671d9869edce40}{enabled}}) \{}
\DoxyCodeLine{82         \textcolor{keywordflow}{if} (loadSymbols()) \textcolor{keywordflow}{return} \mbox{\hyperlink{_a_audio_extensions_8h_a00a6cba3197036499d9a9b13acb8680f}{AAUDIO\_ERROR\_UNAVAILABLE}};}
\DoxyCodeLine{83         \textcolor{keywordflow}{if} (mAAudio\_setMMapPolicy == \textcolor{keyword}{nullptr}) \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{84         \textcolor{keywordflow}{return} mAAudio\_setMMapPolicy(\mbox{\hyperlink{namespacegl_a6dfcb2772a382ca14a671d9869edce40}{enabled}} ? AAUDIO\_POLICY\_AUTO : AAUDIO\_POLICY\_NEVER);}
\DoxyCodeLine{85     \}}
\DoxyCodeLine{86 }
\DoxyCodeLine{87     \textcolor{keywordtype}{bool} \mbox{\hyperlink{classoboe_1_1_a_audio_extensions_a2339699592f7dff7b1a9363b62f42616}{isMMapEnabled}}() \{}
\DoxyCodeLine{88         \textcolor{keywordflow}{if} (loadSymbols()) \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{89         \textcolor{keywordflow}{if} (mAAudio\_getMMapPolicy == \textcolor{keyword}{nullptr}) \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{90         int32\_t policy = mAAudio\_getMMapPolicy();}
\DoxyCodeLine{91         \textcolor{keywordflow}{return} \mbox{\hyperlink{classoboe_1_1_a_audio_extensions_a651d0e11691bb9612b05ea33cee1c189}{isPolicyEnabled}}(policy);}
\DoxyCodeLine{92     \}}
\DoxyCodeLine{93 }
\DoxyCodeLine{94     \textcolor{keywordtype}{bool} \mbox{\hyperlink{classoboe_1_1_a_audio_extensions_a7bcab97bf77a2d5416390345d0aad296}{isMMapSupported}}() \{}
\DoxyCodeLine{95         \textcolor{keywordflow}{return} mMMapSupported;}
\DoxyCodeLine{96     \}}
\DoxyCodeLine{97 }
\DoxyCodeLine{98     \textcolor{keywordtype}{bool} \mbox{\hyperlink{classoboe_1_1_a_audio_extensions_a1117683e03f5c182bdab658e91a3baf3}{isMMapExclusiveSupported}}() \{}
\DoxyCodeLine{99         \textcolor{keywordflow}{return} mMMapExclusiveSupported;}
\DoxyCodeLine{100     \}}
\DoxyCodeLine{101 }
\DoxyCodeLine{102 \textcolor{keyword}{private}:}
\DoxyCodeLine{103 }
\DoxyCodeLine{104     \textcolor{keyword}{enum} \{}
\DoxyCodeLine{105         AAUDIO\_POLICY\_NEVER = 1,}
\DoxyCodeLine{106         AAUDIO\_POLICY\_AUTO,}
\DoxyCodeLine{107         AAUDIO\_POLICY\_ALWAYS}
\DoxyCodeLine{108     \};}
\DoxyCodeLine{109     \textcolor{keyword}{typedef} int32\_t aaudio\_policy\_t;}
\DoxyCodeLine{110 }
\DoxyCodeLine{111     \textcolor{keywordtype}{int} getIntegerProperty(\textcolor{keyword}{const} \textcolor{keywordtype}{char} *\mbox{\hyperlink{namespacegl_a23f4d6c2fb3e8fdfb824894be7a695c2}{name}}, \textcolor{keywordtype}{int} defaultValue) \{}
\DoxyCodeLine{112         \textcolor{keywordtype}{int} \mbox{\hyperlink{namespacegl_a7cb1126dbc1cb105bcce082cff5ae633}{result}} = defaultValue;}
\DoxyCodeLine{113         \textcolor{keywordtype}{char} valueText[PROP\_VALUE\_MAX] = \{0\};}
\DoxyCodeLine{114         \textcolor{keywordflow}{if} (\_\_system\_property\_get(\mbox{\hyperlink{namespacegl_a23f4d6c2fb3e8fdfb824894be7a695c2}{name}}, valueText) != 0) \{}
\DoxyCodeLine{115             \mbox{\hyperlink{namespacegl_a7cb1126dbc1cb105bcce082cff5ae633}{result}} = atoi(valueText);}
\DoxyCodeLine{116         \}}
\DoxyCodeLine{117         \textcolor{keywordflow}{return} \mbox{\hyperlink{namespacegl_a7cb1126dbc1cb105bcce082cff5ae633}{result}};}
\DoxyCodeLine{118     \}}
\DoxyCodeLine{119 }
\DoxyCodeLine{127     aaudio\_result\_t loadSymbols() \{}
\DoxyCodeLine{128         \textcolor{keywordflow}{if} (mAAudio\_getMMapPolicy != \textcolor{keyword}{nullptr}) \{}
\DoxyCodeLine{129             \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{130         \}}
\DoxyCodeLine{131 }
\DoxyCodeLine{132         \textcolor{keywordtype}{void} *libHandle = \mbox{\hyperlink{classoboe_1_1_a_audio_loader_a541af5b3efa57cf31e948f7698a1dcb0}{AAudioLoader::getInstance}}()-\/>\mbox{\hyperlink{classoboe_1_1_a_audio_loader_aff2b742a729e374ffc460e5ddea411df}{getLibHandle}}();}
\DoxyCodeLine{133         \textcolor{keywordflow}{if} (libHandle == \textcolor{keyword}{nullptr}) \{}
\DoxyCodeLine{134             \mbox{\hyperlink{_oboe_debug_8h_a5512e59d578a380a441a70256af997d0}{LOGI}}(\textcolor{stringliteral}{"{}\%s() could not find "{}} \mbox{\hyperlink{_a_audio_extensions_8h_a43dc4d22748734648c65b8429b50a765}{LIB\_AAUDIO\_NAME}}, \_\_func\_\_);}
\DoxyCodeLine{135             \textcolor{keywordflow}{return} \mbox{\hyperlink{_a_audio_extensions_8h_a00a6cba3197036499d9a9b13acb8680f}{AAUDIO\_ERROR\_UNAVAILABLE}};}
\DoxyCodeLine{136         \}}
\DoxyCodeLine{137 }
\DoxyCodeLine{138         mAAudioStream\_isMMap = (bool (*)(\mbox{\hyperlink{namespaceoboe_ac7cdd4062ef770523057fef4aaf96abf}{AAudioStream}} *\mbox{\hyperlink{namespacegl_a3a0f500782e4461d09f1e29189835b3d}{stream}}))}
\DoxyCodeLine{139                 dlsym(libHandle, \mbox{\hyperlink{_a_audio_extensions_8h_a509c5a2a96b5cf0bc3651f3c8b76998b}{FUNCTION\_IS\_MMAP}});}
\DoxyCodeLine{140         \textcolor{keywordflow}{if} (mAAudioStream\_isMMap == \textcolor{keyword}{nullptr}) \{}
\DoxyCodeLine{141             \mbox{\hyperlink{_oboe_debug_8h_a5512e59d578a380a441a70256af997d0}{LOGI}}(\textcolor{stringliteral}{"{}\%s() could not find "{}} \mbox{\hyperlink{_a_audio_extensions_8h_a509c5a2a96b5cf0bc3651f3c8b76998b}{FUNCTION\_IS\_MMAP}}, \_\_func\_\_);}
\DoxyCodeLine{142             \textcolor{keywordflow}{return} \mbox{\hyperlink{_a_audio_extensions_8h_a00a6cba3197036499d9a9b13acb8680f}{AAUDIO\_ERROR\_UNAVAILABLE}};}
\DoxyCodeLine{143         \}}
\DoxyCodeLine{144 }
\DoxyCodeLine{145         mAAudio\_setMMapPolicy = (int32\_t (*)(aaudio\_policy\_t policy))}
\DoxyCodeLine{146                 dlsym(libHandle, \mbox{\hyperlink{_a_audio_extensions_8h_ad2641b84ddb85f1a9e8ab4314006e78f}{FUNCTION\_SET\_MMAP\_POLICY}});}
\DoxyCodeLine{147         \textcolor{keywordflow}{if} (mAAudio\_setMMapPolicy == \textcolor{keyword}{nullptr}) \{}
\DoxyCodeLine{148             \mbox{\hyperlink{_oboe_debug_8h_a5512e59d578a380a441a70256af997d0}{LOGI}}(\textcolor{stringliteral}{"{}\%s() could not find "{}} \mbox{\hyperlink{_a_audio_extensions_8h_ad2641b84ddb85f1a9e8ab4314006e78f}{FUNCTION\_SET\_MMAP\_POLICY}}, \_\_func\_\_);}
\DoxyCodeLine{149             \textcolor{keywordflow}{return} \mbox{\hyperlink{_a_audio_extensions_8h_a00a6cba3197036499d9a9b13acb8680f}{AAUDIO\_ERROR\_UNAVAILABLE}};}
\DoxyCodeLine{150         \}}
\DoxyCodeLine{151 }
\DoxyCodeLine{152         mAAudio\_getMMapPolicy = (aaudio\_policy\_t (*)())}
\DoxyCodeLine{153                 dlsym(libHandle, \mbox{\hyperlink{_a_audio_extensions_8h_a88bbbe6560b461de8da83b9f03f81f8e}{FUNCTION\_GET\_MMAP\_POLICY}});}
\DoxyCodeLine{154         \textcolor{keywordflow}{if} (mAAudio\_getMMapPolicy == \textcolor{keyword}{nullptr}) \{}
\DoxyCodeLine{155             \mbox{\hyperlink{_oboe_debug_8h_a5512e59d578a380a441a70256af997d0}{LOGI}}(\textcolor{stringliteral}{"{}\%s() could not find "{}} \mbox{\hyperlink{_a_audio_extensions_8h_a88bbbe6560b461de8da83b9f03f81f8e}{FUNCTION\_GET\_MMAP\_POLICY}}, \_\_func\_\_);}
\DoxyCodeLine{156             \textcolor{keywordflow}{return} \mbox{\hyperlink{_a_audio_extensions_8h_a00a6cba3197036499d9a9b13acb8680f}{AAUDIO\_ERROR\_UNAVAILABLE}};}
\DoxyCodeLine{157         \}}
\DoxyCodeLine{158 }
\DoxyCodeLine{159         \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{160     \}}
\DoxyCodeLine{161 }
\DoxyCodeLine{162     \textcolor{keywordtype}{bool}      mMMapSupported = \textcolor{keyword}{false};}
\DoxyCodeLine{163     \textcolor{keywordtype}{bool}      mMMapExclusiveSupported = \textcolor{keyword}{false};}
\DoxyCodeLine{164 }
\DoxyCodeLine{165     bool    (*mAAudioStream\_isMMap)(\mbox{\hyperlink{namespaceoboe_ac7cdd4062ef770523057fef4aaf96abf}{AAudioStream}} *\mbox{\hyperlink{namespacegl_a3a0f500782e4461d09f1e29189835b3d}{stream}}) = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{166     int32\_t (*mAAudio\_setMMapPolicy)(aaudio\_policy\_t policy) = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{167     aaudio\_policy\_t (*mAAudio\_getMMapPolicy)() = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{168 \};}
\DoxyCodeLine{169 }
\DoxyCodeLine{170 \} \textcolor{comment}{// namespace oboe}}
\DoxyCodeLine{171 }
\DoxyCodeLine{172 \textcolor{preprocessor}{\#endif }\textcolor{comment}{//OBOE\_AAUDIO\_EXTENSIONS\_H}}

\end{DoxyCode}
